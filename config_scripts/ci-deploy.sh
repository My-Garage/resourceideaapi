#! /bin/bash
# exit script when any command ran here returns with non-zero exit code
set -e

COMMIT_SHA1=$CIRCLE_SHA1

# We must export it so it's available for envsubst
export COMMIT_SHA1=$COMMIT_SHA1

# since the only way for envsubst to work on files is using input/output redirection,
#  it's not possible to do in-place substitution, so we need to save the output to another file
#  and overwrite the original with that one.
envsubst <./k8s/deployment.yml >./k8s/deployment.yml.out
mv ./k8s/deployment.yml.out ./k8s/deployment.yml

echo "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURKekNDQWcrZ0F3SUJBZ0lDQm5Vd0RRWUpLb1pJaHZjTkFRRUxCUUF3TXpFVk1CTUdBMVVFQ2hNTVJHbG4KYVhSaGJFOWpaV0Z1TVJvd0dBWURWUVFERXhGck9ITmhZWE1nUTJ4MWMzUmxjaUJEUVRBZUZ3MHlNREExTWpreApOekUwTkRKYUZ3MDBNREExTWpreE56RTBOREphTURNeEZUQVRCZ05WQkFvVERFUnBaMmwwWVd4UFkyVmhiakVhCk1CZ0dBMVVFQXhNUmF6aHpZV0Z6SUVOc2RYTjBaWElnUTBFd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUIKRHdBd2dnRUtBb0lCQVFDbm5iQXAyWXQ5amJBbCtOSm44ZlhQN3JMaFc0aW9IekFrK0hsUFBNdlNwRWNSS3lUOApjMUxKNUd0cStZbWs4TTBNMi8yNWFxVHBZUXNUVlI0K2ZvZndMeDFJREZWNndtZkJmUFhLM09zNWJiMi83L2VSCmg0eVVlalkxUDdqNytrc09zakVUa0FTWHIzS1VlOEFlTTBXRmZUcUlxalJqNEEyeG9uSVAvUmd2aTdCUCtTVmcKanNCQlh1eTFBaHV1dWFTamtnNGVyTXhjV0tLaXQxUGw1M1U4L0tnNG9RNnVXNHF4dFhPSHd6N0VwdmdlN3pEeQpUbnpOaTNkUHFxdnVMWUxwY3VGR1pkNUZRY2hDZllEYjRtMXJGN3ppUUxFazBURDdVb21senhZNHlXMEtSNG44CmlTcE5wKzV1MGE0NXhiMWtmdGdFWUpzTEJTYVhmeENGRjUySkFnTUJBQUdqUlRCRE1BNEdBMVVkRHdFQi93UUUKQXdJQmhqQVNCZ05WSFJNQkFmOEVDREFHQVFIL0FnRUFNQjBHQTFVZERnUVdCQlJTakRuUjNTVWZrRi9MMU9DaAozbm1NcFpjc2xUQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFKVXRtekZmWFdhNzZYU1RhYTJwSVU2NTlhVDVTCkdsbTFXS2pHaWpWQWlBSnJIUlkxMkJEQjF2MW50WVJmMnpUY252cFpZMnk5NGZvR3RxMlozekttL0RLS05hd2YKdXF5MHpmOEhSV1VJOU1nWFE3ZnMzdzRMTlIrZDFGMDZtdTVNdUEyUkNQQjIycHBOcnBxU2QvU3FET00zbVE0ZApxaVRHczhOOWNoaTdIN1NOdEFNdjdReFZySGcraUgyQUM5K1dCNjZYVkk2RWNIWVZOQ1dJeVhuR05LenFsczg0CnhJVXZkanNOQ1lxS0tRQmdKQ1FGMnplTHFGTnU4anF6SW8rRmlxbW0yNkx5cWF3eXpXaDU4bXRFSFNLQTR3Q08KM1EyajJxZy9NSmdTd05tWjE5MCsrNTlTUk81RThDQWtWWkR5Rm5sN0dLKzFiMGt3amlHK2FWcU5jUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K" | base64 --decode > cert.crt

./kubectl \
  --kubeconfig=/dev/null \
  --insecure-skip-tls-verify 
  --server=https://1388d674-433c-4da7-8ca0-8fd9c3a54886.k8s.ondigitalocean.com \
  --certificate-authority=cert.crt \
  --token=eyJhbGciOiJSUzI1NiIsImtpZCI6ImJXZ0xybGt0RUZPamF2cFAtMExJSFNMeE5VZV9ESlJidXF4cmtkTEFxYlkifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJyZXNvdXJjZWlkZWFhcGkiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlY3JldC5uYW1lIjoiY2ljZC10b2tlbi0yNG01cyIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJjaWNkIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiOGVlNWQ1NzEtN2UyZC00OTU4LWI3NTQtNDUzN2ExYjY2Mzk1Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OnJlc291cmNlaWRlYWFwaTpjaWNkIn0.KbPILSoaqwt8vOayxedAagpvwh2DOTN0oL9XXrGersiB-W4Ga19XgAUCbiYQLVDzQ-NDRyJVDRn4sktLoFTKAGc9RCIOeBxU6p9WI3MmZdI4WBfK31uTn_h8zemaXMXAdTEJtecvoa37yL6-UvYuCBKAHoDAjl-oEtKqjE5D_RlnCi939zwK7A2lo0raJQLAeb-E9a7yKqZi7kFmnSBNNcgXzYPhzZPtuYJTZ2a-HNi-TiKBY1hH6gBNCivBKet-3qZYc7VtIVW0TLd07sMSoVkv6GuJE6g28lb7uKKozjAN6_OeqKHqxpeDM98QE5yaykmV7BhwBKHKcdrAOODkgg% \
  apply -f ./k8s/ -n resourceideaapi